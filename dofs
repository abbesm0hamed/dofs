#!/bin/bash

# dofs - Fedora Workstation Dotfiles Manager
# A CLI tool to manage your system maintenance and setup

# Get the absolute path of the repository root
# This follows symlinks to find the actual location of the script
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
REPO_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

usage() {
    echo "Usage: dofs [command] [argument]"
    echo ""
    echo "Commands:"
    echo "  update            Run the unified system update (DNF, Flatpak, Nvim, Fish)"
    echo "  doctor            Run session health diagnostics"
    echo "  docs              Generate keybindings documentation"
    echo "  install [script]  Run the full installation or a specific setup script"
    echo "  uninstall         Remove all installed components and configurations (Not yet implemented)"
    echo "  verify            Run the health check / verification script"
    echo "  test              Run installation test in Docker (CI)"
    echo "  help              Show this help message"
}

case "${1:-help}" in
    "test")
        bash "$REPO_ROOT/tests/test-install.sh"
        ;;
    "update")
        bash "$REPO_ROOT/scripts/maintenance/update-all.sh"
        # Clear waybar update cache and send signal to refresh
        rm -f "/tmp/waybar_check_updates_cache" 2>/dev/null
        pkill -RTMIN+9 waybar 2>/dev/null || true
        ;;
    "doctor")
        bash "$REPO_ROOT/scripts/maintenance/doctor.sh"
        ;;
    "docs")
        bash "$REPO_ROOT/scripts/maintenance/generate-keybindings.sh"
        ;;
    "install")
        if [ -z "$2" ]; then
            log "Running full installation via Ansible..."
            bash "$REPO_ROOT/bootstrap.sh"
        else
            echo "Direct setup scripts are deprecated. Please use 'dofs install' for full Ansible setup."
            echo "Most components are now managed via Ansible roles in $REPO_ROOT/ansible/roles"
            exit 1
        fi
        ;;
    "uninstall")
        bash "$REPO_ROOT/scripts/maintenance/uninstall.sh"
        ;;
    "verify")
        bash "$REPO_ROOT/scripts/setup/verify.sh"
        ;;
    "help")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
