#!/bin/bash

# dofs - Fedora Workstation Dotfiles Manager
# A CLI tool to manage your system maintenance and setup

# Get the absolute path of the repository root
# This follows symlinks to find the actual location of the script
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
REPO_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

usage() {
    echo "Usage: dofs [command] [argument]"
    echo ""
    echo "Commands:"
    echo "  update            Run the unified system update (DNF, Flatpak, Nvim, Fish)"
    echo "  doctor            Run session health diagnostics"
    echo "  docs              Generate keybindings documentation"
    echo "  install [script]  Run the full installation or a specific setup script"
    echo "  uninstall         Remove all installed components and configurations (Not yet implemented)"
    echo "  verify            Run the health check / verification script"
    echo "  test              Run installation test in Docker (CI)"
    echo "  help              Show this help message"
}

case "${1:-help}" in
    "test")
        bash "$REPO_ROOT/tests/test-install.sh"
        ;;
    "update")
        bash "$REPO_ROOT/scripts/maintenance/update-all.sh"
        # Clear waybar update cache and send signal to refresh
        rm -f "/tmp/waybar_check_updates_cache" 2>/dev/null
        pkill -RTMIN+9 waybar 2>/dev/null || true
        ;;
    "doctor")
        bash "$REPO_ROOT/scripts/maintenance/doctor.sh"
        ;;
    "docs")
        bash "$REPO_ROOT/scripts/maintenance/generate-keybindings.sh"
        ;;
    "install")
        if [ -z "$2" ]; then
            bash "$REPO_ROOT/install.sh"
        else
            script_name="$2"
            if [[ ! "$script_name" == *".sh" ]]; then
                script_name="${script_name}.sh"
            fi

            shopt -s nullglob
            valid_scripts=($(basename -a "$REPO_ROOT"/scripts/setup/*.sh))
            shopt -u nullglob

            if [[ " ${valid_scripts[*]} " =~ " ${script_name} " ]]; then
                script_path="$REPO_ROOT/scripts/setup/${script_name}"
                export REPO_ROOT
                export LOG_FILE="${REPO_ROOT}/install.log"
                log() { printf "\033[1;34m==> %s\033[0m\n" "$1"; }
                title=$(echo "$script_name" | cut -f 1 -d '.' | tr 'a-z' 'A-Z')
                log "TOPIC: $title"
                bash "$script_path"
            else
                echo "Error: Invalid script name '$2'."
                echo "Available scripts: ${valid_scripts[*]%.sh}"
                exit 1
            fi
        fi
        ;;
    "uninstall")
        bash "$REPO_ROOT/scripts/maintenance/uninstall.sh"
        ;;
    "verify")
        bash "$REPO_ROOT/scripts/setup/verify.sh"
        ;;
    "help")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
