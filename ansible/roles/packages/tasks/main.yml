---
- name: Install community.general collection
  command: ansible-galaxy collection install community.general
  register: collection_install
  changed_when: "'is already installed' not in collection_install.stdout"
  args:
    creates: "{{ ansible_user_dir }}/.ansible/collections/ansible_collections/community/general"

- name: Enable COPR repositories
  command: "dnf copr enable -y {{ item }}"
  loop: "{{ copr_repos }}"
  become: true
  changed_when: false
  register: copr_result
  until: copr_result.rc == 0
  retries: 3
  delay: 2

- name: Install DNF packages
  ansible.builtin.dnf:
    name: "{{ dnf_packages }}"
    state: present
  become: true

- name: Add Flathub remote
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
  become: true

- name: Install Flatpak applications
  community.general.flatpak:
    name: "{{ item }}"
    state: present
    remote: flathub
  loop: "{{ flatpaks }}"
  become: true

- name: Set Flatpak filesystem overrides for themes
  command: flatpak override --user --filesystem=xdg-config/gtk-3.0:ro --filesystem=xdg-config/gtk-4.0:ro --filesystem=~/.themes:ro --filesystem=~/.local/share/icons:ro
  become: false
  changed_when: false

